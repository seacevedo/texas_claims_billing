with prof_billing_header as (
    select 
    BILL_ID,
    BILL_SELECTION_DATE,
    BILL_TYPE,
    INSURER_FEIN,
    INSURER_POSTAL_CODE,
    DATE_INSURER_RECEIVED_BILL,
    DATE_INSURER_PAID_BILL,
    FACILITY_FEIN,
    FACILITY_NAME,
    FACILITY_ADDRESS,
    FACILITY_CITY,
    FACILITY_STATE_CODE,
    FACILITY_POSTAL_CODE,
    FACILITY_COUNTRY_CODE,
    null as FACILITY_CODE,
    EMPLOYER_FEIN,
    EMPLOYER_PHYSICAL_CITY,
    EMPLOYER_PHYSICAL_STATE_CODE,
    EMPLOYER_PHYSICAL_POSTAL,
    BILLING_PROVIDER_FEIN,
    RENDERING_BILL_PROVIDER_FEIN,
    REFERRING_PROVIDER_FEIN,
    BILLING_PROVIDER_FIRST_NAME,
    RENDERING_BILL_PROVIDER_FIRST_NAME,
    REFERRING_PROVIDER_FIRST_NAME,
    BILLING_PROVIDER_LAST_NAME,
    RENDERING_BILL_PROVIDER_LAST_NAME,
    REFERRING_PROVIDER_LAST_NAME,
    BILLING_PROVIDER_ADDRESS,
    RENDERING_BILL_PROVIDER_ADDRESS,
    BILLING_PROVIDER_CITY,
    RENDERING_BILL_PROVIDER_CITY,
    BILLING_PROVIDER_STATE_CODE,
    RENDERING_BILL_PROVIDER_STATE,
    BILLING_PROVIDER_POSTAL_CODE,
    RENDERING_BILL_PROVIDER_POSTAL,
    BILLING_PROVIDER_COUNTRY,
    RENDERING_BILL_PROVIDER_COUNTRY_CODE,
    null as ADMISSION_HOUR,
    null as ADMISSION_DATE,
    null as ADMISSION_TYPE_CODE,
    null as ADMITTING_DIAGNOSIS_CODE,
    null as PRINCIPAL_DIAGNOSIS_CODE,
    EMPLOYEE_MAILING_CITY,
    EMPLOYEE_MAILING_STATE_CODE,
    EMPLOYEE_MAILING_POSTAL_CODE,
    EMPLOYEE_MAILING_COUNTRY,
    EMPLOYEE_DATE_OF_BIRTH,
    EMPLOYEE_GENDER_CODE, 
    EMPLOYEE_MARITAL_STATUS_CODE, 
    EMPLOYEE_DATE_OF_INJURY
    from {{ref('stg_prof_billing_header')}}
),

inst_billing_header as (
    select 
    BILL_ID,
    BILL_SELECTION_DATE,
    BILL_TYPE,
    INSURER_FEIN,
    INSURER_POSTAL_CODE,
    DATE_INSURER_RECEIVED_BILL,
    DATE_INSURER_PAID_BILL,
    FACILITY_FEIN,
    FACILITY_NAME,
    FACILITY_ADDRESS,
    FACILITY_CITY,
    FACILITY_STATE_CODE,
    FACILITY_POSTAL_CODE,
    FACILITY_COUNTRY_CODE,
    FACILITY_CODE,
    EMPLOYER_FEIN,
    EMPLOYER_PHYSICAL_CITY,
    EMPLOYER_PHYSICAL_STATE_CODE,
    EMPLOYER_PHYSICAL_POSTAL,
    BILLING_PROVIDER_FEIN,
    RENDERING_BILL_PROVIDER_FEIN,
    null as REFERRING_PROVIDER_FEIN,
    null as BILLING_PROVIDER_FIRST_NAME,
    RENDERING_BILL_PROVIDER_FIRST_NAME,
    REFERRING_PROVIDER_FIRST_NAME,
    BILLING_PROVIDER_LAST_NAME,
    RENDERING_BILL_PROVIDER_LAST_NAME,
    REFERRING_PROVIDER_LAST_NAME,
    BILLING_PROVIDER_ADDRESS,
    RENDERING_BILL_PROVIDER_ADDRESS,
    BILLING_PROVIDER_CITY,
    RENDERING_BILL_PROVIDER_CITY,
    BILLING_PROVIDER_STATE_CODE,
    RENDERING_BILL_PROVIDER_STATE,
    BILLING_PROVIDER_POSTAL_CODE,
    RENDERING_BILL_PROVIDER_POSTAL,
    BILLING_PROVIDER_COUNTRY,
    RENDERING_BILL_PROVIDER_COUNTRY_CODE,
    ADMISSION_HOUR, 
    ADMISSION_DATE,
    ADMISSION_TYPE_CODE, 
    ADMITTING_DIAGNOSIS_CODE,
    PRINCIPAL_DIAGNOSIS_CODE,
    EMPLOYEE_MAILING_CITY,
    EMPLOYEE_MAILING_STATE_CODE,
    EMPLOYEE_MAILING_POSTAL_CODE,
    EMPLOYEE_MAILING_COUNTRY,
    EMPLOYEE_DATE_OF_BIRTH,
    EMPLOYEE_GENDER_CODE, 
    EMPLOYEE_MARITAL_STATUS_CODE, 
    EMPLOYEE_DATE_OF_INJURY
    from {{ref('stg_inst_billing_header')}}
),

unique_header as (
    select * from prof_billing_header
    union 
    select * from inst_billing_header
),

unique_detail as (
    select *, row_number() over(partition by BILL_ID order by BILL_SELECTION_DATE) as row_number
    from unique_header
)

select * exclude row_number, current_timestamp() as transformed_timestamp
from unique_detail
where row_number = 1